<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin â€” WHITELINEZ</title>
  <link rel="stylesheet" href="/css/main.css" />
</head>
<body class="dark admin-page">

  <header class="site-header">
    <a href="/index.html" class="logo"><img src="/img/whitelinezlogo.png" alt="WHITELINEZ" /></a>
    <span class="admin-badge">ADMIN</span>
    <nav>
      <a href="/index.html">Public View</a>
      <button onclick="Auth.logout()">Logout</button>
    </nav>
  </header>

  <main class="admin-main">

    <!-- Line draw tool -->
    <section class="admin-section">
      <h2>Count Line Editor</h2>
      <p class="admin-hint">Click two points on the live feed to define the counting line. Vehicles crossing this line will be tracked by the AI.</p>

      <div class="stream-canvas-wrapper">
        <video id="admin-video" muted playsinline autoplay></video>
        <canvas id="line-canvas"></canvas>
      </div>

      <div class="admin-line-controls">
        <button id="btn-clear-line" class="btn-secondary">Clear Line</button>
        <button id="btn-save-line" class="btn-primary" disabled>Save Line</button>
        <span id="line-status" class="line-status"></span>
      </div>
    </section>

    <!-- Round management -->
    <section class="admin-section">
      <h2>Create Round</h2>
      <form id="round-form" onsubmit="handleCreateRound(event)">
        <div class="field-row">
          <div class="field">
            <label for="market-type">Market Type</label>
            <select id="market-type">
              <option value="over_under">Over / Under</option>
              <option value="vehicle_type">Vehicle Type Leader</option>
            </select>
          </div>
          <div class="field">
            <label for="threshold">Threshold (for Over/Under)</label>
            <input id="threshold" type="number" min="1" value="20" />
          </div>
        </div>
        <div class="field-row">
          <div class="field">
            <label for="opens-at">Opens At</label>
            <input id="opens-at" type="datetime-local" required />
          </div>
          <div class="field">
            <label for="closes-at">Closes At</label>
            <input id="closes-at" type="datetime-local" required />
          </div>
          <div class="field">
            <label for="ends-at">Ends At</label>
            <input id="ends-at" type="datetime-local" required />
          </div>
        </div>
        <p id="round-error" class="auth-error" role="alert"></p>
        <p id="round-success" class="auth-success" role="status"></p>
        <button type="submit" class="btn-primary" id="round-submit-btn">Create Round</button>
      </form>
    </section>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1/dist/hls.min.js"></script>
  <script>
    window.SUPABASE_URL = "https://zaxycvrbdzkptjzrcxel.supabase.co";
    window.SUPABASE_ANON_KEY = "sb_publishable_HkiBzidTPAxdNWuQMa-Lgw_E-sieyPx";
  </script>
  <script src="/js/supabase-init.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/stream.js"></script>
  <script src="/js/admin-line.js"></script>
  <script>
    let adminSession = null;

    async function init() {
      adminSession = await Auth.requireAdmin("/index.html");
      if (!adminSession) return;

      // Load first active camera
      const { data: cameras } = await window.sb
        .from("cameras")
        .select("id, name")
        .eq("is_active", true)
        .limit(1);

      const cameraId = cameras?.[0]?.id;

      // Init stream
      const video = document.getElementById("admin-video");
      await Stream.init(video);

      // Sync canvas size on video load
      video.addEventListener("loadedmetadata", () => {
        const canvas = document.getElementById("line-canvas");
        AdminLine.init(video, canvas, cameraId);
      });
    }

    async function handleCreateRound(e) {
      e.preventDefault();
      const errorEl = document.getElementById("round-error");
      const successEl = document.getElementById("round-success");
      const btn = document.getElementById("round-submit-btn");

      errorEl.textContent = "";
      successEl.textContent = "";
      btn.disabled = true;

      const jwt = adminSession?.access_token;
      if (!jwt) return;

      const marketType = document.getElementById("market-type").value;
      const threshold = parseInt(document.getElementById("threshold").value, 10);
      const opensAt = new Date(document.getElementById("opens-at").value).toISOString();
      const closesAt = new Date(document.getElementById("closes-at").value).toISOString();
      const endsAt = new Date(document.getElementById("ends-at").value).toISOString();

      const { data: cameras } = await window.sb
        .from("cameras").select("id").eq("is_active", true).limit(1);
      const cameraId = cameras?.[0]?.id;

      const markets = marketType === "over_under"
        ? [
            { label: `Over ${threshold} vehicles`, outcome_key: "over", odds: 1.90 },
            { label: `Under ${threshold} vehicles`, outcome_key: "under", odds: 1.90 },
            { label: `Exactly ${threshold} vehicles`, outcome_key: "exact", odds: 15.00 },
          ]
        : [
            { label: "Cars lead", outcome_key: "car", odds: 2.00 },
            { label: "Trucks lead", outcome_key: "truck", odds: 3.50 },
            { label: "Buses lead", outcome_key: "bus", odds: 4.00 },
            { label: "Motorcycles lead", outcome_key: "motorcycle", odds: 5.00 },
          ];

      try {
        const res = await fetch("/api/bets/place", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${jwt}`,
          },
          // Actually call the admin round endpoint directly
          // (reusing proxy concept)
        });

        // Direct Railway call via admin endpoint
        const railwayRes = await fetch(`${window._railwayBase}/admin/rounds`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${jwt}`,
          },
          body: JSON.stringify({
            camera_id: cameraId,
            market_type: marketType,
            params: { threshold, duration_sec: Math.floor((new Date(endsAt) - new Date(opensAt)) / 1000) },
            opens_at: opensAt,
            closes_at: closesAt,
            ends_at: endsAt,
            markets,
          }),
        });

        if (!railwayRes.ok) {
          const err = await railwayRes.json();
          throw new Error(err.detail || "Failed to create round");
        }

        successEl.textContent = "Round created successfully!";
      } catch (err) {
        errorEl.textContent = err.message;
      } finally {
        btn.disabled = false;
      }
    }

    init();
  </script>
</body>
</html>
